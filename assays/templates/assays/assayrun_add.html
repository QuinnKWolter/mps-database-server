{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block load %}
    <script src="{% static "js/inline_add.js" %}"></script>
    <script src="{% static "js/image_display.js" %}"></script>
    <script src="{% static "js/enter_override.js" %}"></script>
    <script src="{% static "js/flag.js" %}"></script>
    <script src="{% static "assays/assayrun_add.js" %}"></script>
{% endblock %}

{% block breadcrumbs %}
    <li><a href="/assays/editable_studies/">Editable Studies</a></li>
    {% if object %}
        <li>
			<a href="/assays/{{ object.id }}">{{ object }}</a>
        </li>
    {% endif %}
    <li class="active">
        {% if object %}
            Edit <em>{{ object }}</em>
        {% else %}
            Add Study
        {% endif %}
    </li>
{% endblock %}

{% block content %}
{% if update %}
    <form enctype="multipart/form-data" class="form-horizontal" method="post" >

    <h1>
        Edit <em>{{ object }}</em>
{% else %}
    <form enctype="multipart/form-data" class="form-horizontal" method="post" >

    <h1>
        Add Study
{% endif %}
    <br>
    {% csrf_token %}
    </h1>

    {% include "submit.html" with flag="y" group=form.instance.group.name study_submit='true' %}

    {% include 'errors.html' %}

    {% include 'tracking.html' with study_submit='true' %}

{#    {% include "sign_off_form.html" with group=form.instance.group.name study_submit='true' %}#}

    {% if user|is_group_admin:object.group.name %}
        <div class="well text-center">
            <a href="../sign_off" class="btn btn-success">Click Here to Sign Off on this Study</a>
        </div>
    {% endif %}

    <legend>Study Details</legend>

    {% if form.group.errors %}
        {% for error in form.group.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="group" class="col-sm-2 control-label">Group*</label>
        <div class="col-sm-10">
          {{ form.group }}
          <span id="center_name"></span>
        </div>
    </div>

    {% if form.non_field_errors %}
        <div class="alert alert-danger" role="alert">
            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
            <span class="sr-only">Error:</span>
            {{ form.non_field_errors }}
        </div>
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="study_type" class="col-sm-2 control-label">Study Types*</label>
        <div class="col-sm-10">
            <label for="toxicity" style="padding-right: 10px;">Toxicity</label>
              {{ form.toxicity }}
            <label for="efficacy" style="padding-left: 20px;padding-right: 10px;">Efficacy</label>
              {{ form.efficacy }}
            <label for="disease" style="padding-left: 20px;padding-right: 10px;">Disease</label>
              {{ form.disease }}
            {# Please note superficial edit from Cell Characterization to Chip Characterization #}
            {# This is subject to change #}
            <label for="cell_characterization" style="padding-left: 20px;padding-right: 10px;">Chip Characterization</label>
              {{ form.cell_characterization }}
        </div>
    </div>

    {% if form.name.errors %}
        {% for error in form.name.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="study_name" class="col-sm-2 control-label">Study Name*</label>
        <div class="col-sm-10">
          {{ form.name }}
        </div>
    </div>

    {% if form.start_date.errors %}
        {% for error in form.start_date.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="start_date" class="col-sm-2 control-label">Start Date*</label>
        <div class="col-sm-10">
          {{ form.start_date }} [yyyy-mm-dd]
          <div>
              This date specifies when treatment of devices began
          </div>
        </div>
    </div>

    {% if form.assay_run_id.errors %}
        {% for error in form.assay_run_id.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="assay_run_id" class="col-sm-2 control-label">Study ID</label>
        <div class="col-sm-10">
          {{ form.assay_run_id }}
        </div>
    </div>

    <div class="form-group">
        <label for="description" class="col-sm-2 control-label">Description</label>
        <div class="col-sm-10">
          {{ form.description }}
        </div>
    </div>

{#    {% if not object or not user|is_group_admin:object.group.name %}#}
{#        <div hidden>#}
{#    {% endif %}#}
{#    <div class="form-group">#}
{#        <label for="restricted" class="col-sm-2 control-label">Restrict Access</label>#}
{#        <div class="col-sm-10">#}
{#          {{ form.restricted }}#}
{#          <div>#}
{#              <em>Check</em> to make this study visible only to users with group access.#}
{#          </div>#}
{#        </div>#}
{#    </div>#}
{#    {% if not object or not user|is_group_admin:object.group.name %}#}
{#        </div>#}
{#    {% endif %}#}

    <div class="form-group">
        <label for="use_in_calculations" class="col-sm-2 control-label">Use in Calculations</label>
        <div class="col-sm-10">
          {{ form.use_in_calculations }}
          <div>
              <em>Check</em> if the data in this study can be used in calculations.
              <br>
              <em>Do not check</em> if this study is faulty or a one-off experiment.
          </div>
        </div>
    </div>

    {% if form.protocol.errors %}
        {% for error in form.protocol.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{ error }}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="protocol" class="col-sm-2 control-label">Protocol File</label>
        <div class="col-sm-10">
            {{ form.protocol }}
            <div>
                You can upload a file for this study's protocol.
                <br>
                The protocol should be <em>specific to this study</em> (i.e. not an organ model protocol).
                <br>
                <b>Preferred Format: PDF</b>
            </div>
        </div>
    </div>

    {% if form.image.errors %}
        {% for error in form.image.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="image" class="col-sm-2 control-label">Image</label>
        <div class="col-sm-10">
            {{ form.image }}
            <p>
                You can upload an image to clarify this study.
                <br>
                <b>Preferred Formats: PNG, JPEG, GIF</b>
            </p>
        </div>
    </div>

    <div id="image_display">
        <div id="current_display">
            {% if object.image %}
                <img class="img-responsive center-block padded-bottom" src="/media/{{ object.image }}">
            {% endif %}
        </div>
    </div>

    <legend>For Integrated Chip Studies</legend>
    {% if form.study_configuration.errors %}
        {% for error in form.study_configuration.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="study_configuration" class="col-sm-2 control-label">Integrated Study Configuration</label>
        <div class="col-sm-10">
            {{ form.study_configuration }}
            <br>
            <a href="/assays/studyconfiguration">
                <span class="glyphicon glyphicon-plus text-success" aria-hidden="true"></span>
                Add/Edit Integrated Study Configurations (Must Refresh Page to See Change)
            </a>
        </div>
    </div>

    {# TODO TODO REFACTOR TO USE form.prefix RATHER THAN USING A MAGIC STRING #}
    {{ assay_instance_formset.management_form }}
    <legend>Assays</legend>

    {% if assay_instance_formset.non_form_errors %}
        <div class="alert alert-danger" role="alert">
            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
            <span class="sr-only">Error:</span>
            {{ assay_instance_formset.non_form_errors }}
        </div>
    {% endif %}

    {% if assay_instance_formset.errors %}
        {% for dict in assay_instance_formset.errors %}
            {% for key,value in dict.items %}
                {% if key %}
                    <div class="alert alert-danger" role="alert">
                        <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                        <span class="sr-only">Error:</span>
                        {{ forloop.parentloop.counter }}.) {{ key }} : {{ value }}
                    </div>
                {% endif %}
            {% endfor %}
        {% endfor %}
    {% endif %}

    <a id="add_button-assayinstance_set" class="btn btn-success" role="button">Add Assay</a>
    <table class="table table-striped inlines" id="assayinstance_set-group"  name="assays">
        <thead>
            <tr>
                <th>Target/Analyte*</th>
                <th>Method/Kit*</th>
                <th>Readout Unit*</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody>
            {% for assay in assay_instance_formset %}
                <tr class="inline" id="assay-{{ forloop.counter0 }}">
                    {# Hidden input for Update (need id to associate) #}
                    {% if assay.id.value %}
                    <td class="original" hidden>
                        <input id="id_assayinstance_set-{{ forloop.counter0 }}-id" name="assayinstance_set-{{ forloop.counter0 }}-id" type="hidden" value="{{ assay.id.value }}">
                    </td>
                    {% endif %}
                    <td>{{ assay.target }}</td>
                    <td>{{ assay.method }}</td>
                    <td>{{ assay.unit }}</td>
                    <td>{{ assay.DELETE }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    {{ supporting_data_formset.management_form }}
    <legend>Supporting Data</legend>
    {% if supporting_data_formset.non_form_errors %}
        <div class="alert alert-danger" role="alert">
            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
            <span class="sr-only">Error:</span>
            {{ supporting_data_formset.non_form_errors }}
        </div>
    {% endif %}

    {% if supporting_data_formset.errors %}
        {% for dict in supporting_data_formset.errors %}
            {% for key,value in dict.items %}
                {% if key %}
                    <div class="alert alert-danger" role="alert">
                        <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                        <span class="sr-only">Error:</span>
                        {{ forloop.parentloop.counter }}.) {{ key }} : {{ value }}
                    </div>
                {% endif %}
            {% endfor %}
        {% endfor %}
    {% endif %}

    <a id="add_button-studysupportingdata_set" class="btn btn-success" role="button">Add Supporting Data</a>
    <table class="table table-striped inlines" id="studysupportingdata_set-group" name="supporting_data">
        <thead>
            <tr>
                <th>Description*</th>
                <th>Supporting Data File*</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody>
            {% for supporting_data in supporting_data_formset %}
                <tr class="inline" id="supporting_data-{{ forloop.counter0 }}">
                    {% if supporting_data.id.value %}
                    <td class="original" hidden>
                        <input type="hidden"
                               id="id_studysupportingdata_set-{{ forloop.counter0 }}-id"
                               name="studysupportingdata_set-{{ forloop.counter0 }}-id"
                               value="{{ supporting_data.id.value }}">
                    </td>
                    {% endif %}
                    <td>{{ supporting_data.description }}</td>
                    <td>{{ supporting_data.supporting_data }}</td>
                    <td>{{ supporting_data.DELETE }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</form>
{% endblock %}
