{% extends "base.html" %}
{% load static %}

{% block load %}
    <script src="{% static "js/inline_add.js" %}"></script>
    <script src="{% static "js/cookies.js" %}"></script>
    <script src="{% static "js/whittle.js" %}"></script>
    <script src="{% static "js/enter_override.js" %}"></script>
    <script src="{% static "js/flag.js" %}"></script>
    <script src="{% static "js/help.js" %}"></script>
    <script src="{% static "assays/customize_plate_results.js" %}"></script>
{% endblock %}

{% block content %}

    {% if update %}
        <form onsubmit="return confirm('Are you sure you want to overwrite this entry?');" class="form-horizontal" method="post">

        {% include 'review.html' %}

        <h1>
            Edit Test Results for <em>{{ object.readout.setup }}</em>
    {% else %}
        <form class="form-horizontal" method="post" >

        <h1>
            Add Plate Test Results
    {% endif %}
        <br>
        {% csrf_token %}

{#            <button id="submit" type="submit" class="btn btn-primary">Submit</button>#}
{##}
{#            {% if update %}#}
{#                <a role="button" class="btn btn-danger pull-right readjust-pulled" href="/assays/assayplatetestresult/{{ object.id }}/delete/">Delete</a>#}
{#            {% endif %}#}
{##}
{#            {% include 'flag.html'%}#}
        </h1>

        {% include "submit.html" with flag="y" help="y" %}

        {% include 'errors.html' %}

        {% include 'tracking.html' %}

        <legend>Plate Test Results</legend>

        {% if form.readout.errors %}
            {% for error in form.readout.errors %}
                <div class="alert alert-danger" role="alert">
                    <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                    <span class="sr-only">Error:</span>
                    {{error}}
                </div>
            {% endfor %}
        <div class="form-group has-error">
        {% else %}
        <div class="form-group">
        {% endif %}
            <label for="readout" class="col-sm-2 control-label">Readout*</label>
            <div class="col-sm-10">
                {{ form.readout }}
            </div>
        </div>

        <div class="form-group">
            <label for="summary" class="col-sm-2 control-label">Summary of Results</label>
            <div class="col-sm-10">
                {{ form.summary }}
            </div>
        </div>

        {{ formset.management_form }}
        <legend>Results</legend>

        {% if formset.non_form_errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{ formset.non_form_errors }}
            </div>
        {% endif %}

        {% if formset.errors %}
            {% for dict in formset.errors %}
                {% for key,value in dict.items %}
                    {% if key %}
                        <div class="alert alert-danger" role="alert">
                            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                            <span class="sr-only">Error:</span>
                            {{ forloop.parentloop.counter }}.) {{ key }} : {{ value }}
                        </div>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        {% endif %}

        <a id="add_button" class="btn btn-success" role="button">Add Result</a>
        <table class="table table-striped results" id="assayplateresult_set-group" name="inlines">
            <thead>
                <tr>
                    <th>Assay &amp; Feature</th>
                    <th>Result</th>
                    <th>Function</th>
                    <th>Measure</th>
                    <th>Value</th>
                    <th>Test Unit</th>
                    <th>Severity</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody>
                {% for result in formset %}
                    <tr class="inline" id="results-{{ forloop.counter0 }}">
                        {# Hidden input for Update (need id to associate) #}
                        {% if result.id.value %}
                        <td class="original" hidden>
                            <input type="hidden" id="id_assayplateresult_set-{{ forloop.counter0 }}-id" name="assayplateresult_set-{{ forloop.counter0 }}-id" value="{{ result.id.value }}">
                        </td>
                        {% endif %}
                        <td>
                            <select id="id_assayplateresult_set-{{ forloop.counter0 }}-assay_name" name="assayplateresult_set-{{ forloop.counter0 }}-assay_name">
                                <option value="">---------</option>
                                {% if result.assay_name.value %}
                                    <option selected value="{{ result.assay_name.value }}">Loading</option>
                                {% endif %}
                            </select>
                        </td>
                        <td>
                            {{ result.result }}
                        </td>
                        <td>
                            {{ result.result_function }}
                        </td>
                        <td>
                            {{ result.result_type }}
                        </td>
                        <td>
                            {{ result.value }}
                        </td>
                        <td>
                            {{ result.test_unit }}
                        </td>
                        <td>
                            {{ result.severity }}
                        </td>
                        <td>
                            {{ result.DELETE }}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </form>

    <div hidden id="help_dialog" title="Plate Test Results Help">
        <h4>Making Plate Test Results</h4>
        <ul class="list-group">
            <li class="list-group-item">
                First, choose a <b>Readout</b>
                <br>
                Without a readout, you are unable to specify <b>Assay & Feature</b>
            </li>
            <li class="list-group-item">
                <b>Summary of Results</b> should be a brief summary of your findings from this plate
                <br>
                These results can be qualitative
            </li>
            <li class="list-group-item">
                Each <b>Result</b> represents a finding from a specific assay
                <br>
                Clicking <b>Add Result</b> will make another row
            </li>
        </ul>
        <h4>Flagging for Review</h4>
        <ul class="list-group">
            <li class="list-group-item">
                Clicking
                <a role='button' class="btn btn-sm" style="color:#337AB7">
                    <span class="glyphicon glyphicon-flag" aria-hidden="true"></span>
                </a>
                flags the current results for review
            </li>
            <li class="list-group-item">
                Clicking
                <a role='button' class="btn btn-sm btn-warning" style="color:#FFFFFF">
                    Notes
                </a>
                brings up an input dialog where you can explain why these results were flagged
            </li>
            <li class="list-group-item">
                Clicking
                <a role='button' class="btn btn-sm btn-danger" style="color:#FFFFFF">
                    <span class="glyphicon glyphicon-flag" aria-hidden="true"></span>
                </a>
                removes the flag from the current results
            </li>
        </ul>
    </div>

{% endblock %}
