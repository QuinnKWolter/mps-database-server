{% extends "base.html" %}
{% load static %}

{% block load %}
    <script src="{% static "js/calendar.js" %}"></script>
    <script src="{% static "js/enter_override.js" %}"></script>
    <script src="{% static "js/flag.js" %}"></script>
    <script src="{% static "assays/matrix_display.js" %}"></script>
    <script src="{% static "assays/compound_instances.js" %}"></script>
{% endblock %}

{% block breadcrumbs %}
{% endblock %}

{% block content %}
    {% if update %}
        <form onsubmit="return confirm(
            'Are you sure you want to overwrite this entry?'
        );" enctype="multipart/form-data" class="form-horizontal" method="post" >

        <h1>
            Edit Matrix <em>{{ object }}</em>
    {% else %}
        <form enctype="multipart/form-data" class="form-horizontal" method="post" >
        <h1>
            Add Matrix
    {% endif %}
    {% csrf_token %}
    </h1>

    {% include "submit.html" with flag="y" clone="y" group=study.group.name %}

    {% include 'errors.html' %}

    {{ form.errors }}

    <legend>Global</legend>

    {% include 'generic_field.html' with field=form.name label="Matrix Name*" %}

    {% include 'generic_field.html' with field=form.notes label="Notes" %}

    {% include 'generic_field.html' with field=form.representation label="Representation*" %}

    <div hidden id="matrix_device_and_model_section" class="matrix-section">
    {% include 'generic_field.html' with field=form.device label="Device" %}
{#    {% include 'generic_field.html' with field=form.organ_model label="Model" %}#}
{#    {% include 'generic_field.html' with field=form.organ_model_protocol label="Protocol" %}#}
{#    {% include 'generic_field.html' with field=form.variance_from_organ_model_protocol label="Variance from Protocol" %}#}
    </div>

    <div hidden id="matrix_dimensions_section" class="matrix-section">
    {% include 'generic_field.html' with field=form.number_of_items label="Number of Items" %}

    {# Dimensions should be on one line if possible #}
    {% if form.number_of_rows.errors or form.number_of_columns.errors  %}
        {% for error in form.number_of_rows.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{ error }}
            </div>
        {% endfor %}
        {% for error in form.number_of_columns.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{ error }}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="number_of_rows" class="col-sm-2 col-md-2 control-label">Number of Rows</label>
        <div class="col-sm-3 col-md-2">
            {{ form.number_of_rows }}
         </div>
        <label for="number_of_columns" class="col-sm-3 col-md-2 control-label">Number of Columns</label>
        <div class="col-sm-4 col-md-6">
            {{ form.number_of_columns }}
        </div>
    </div>
    </div>

    <legend>Individual</legend>

    <div hidden>
        {{ form.item_data }}
        {{ form.setup_data }}
        {{ form.setup_set_data }}
    </div>

    <div class="well">
    {% include 'generic_field.html' with field=form.action label="Action" %}

    <div hidden id="add_name_section" class="item-section">
    {% include 'generic_field.html' with field=form.item_name label="Name*" %}

{#    <div class="form-group">#}
{#        <label for="increment_name_by_one" class="col-sm-2 control-label">Increment Name by 1 Each Cell</label>#}
{#        <div class="col-sm-10">#}
{#            <input id="increment_name_by_one" type="checkbox" value="">#}
{#        </div>#}
{#    </div>#}

    <div align="center">
        <a role="button" id="apply_plate_names" class="btn btn-info">Apply Default Plate Names</a>
    </div>
    </div>

    <div hidden id="add_date_section" class="item-section">
    {% include 'generic_field.html' with field=form.item_setup_date label="Setup Date*" %}
    </div>

    <div hidden id="add_notes_section" class="item-section">
    {% include 'generic_field.html' with field=form.item_scientist label="Scientist" %}
    {% include 'generic_field.html' with field=form.item_notebook label="Notebook" %}
    {% include 'generic_field.html' with field=form.item_notebook_page label="Notebook Page" %}
    {% include 'generic_field.html' with field=form.item_notes label="Notes" %}
    </div>

    <div hidden id="add_device_section" class="item-section">
    {% include 'generic_field.html' with field=form.setup_device label="Device*" %}
    {% include 'generic_field.html' with field=form.setup_organ_model label="Organ Model" %}
    {% include 'generic_field.html' with field=form.setup_organ_model_protocol label="Organ Model Protocol" %}
    {% include 'generic_field.html' with field=form.setup_variance_from_organ_model_protocol label="Variance from Protocol" %}
    </div>

    <div hidden id="add_failure_section" class="item-section">
    {# TODO TODO TODO #}
    </div>

    <div hidden id="add_compounds_section" class="item-section">
    <div class="row">
    <div class="col-sm-1"></div>
    <div class="col-sm-11">
{#    <table class="table table-condensed table-bordered table-nonfluid no-margin-bottom">#}
{#        <tr>#}
{#            <th colspan="2">Compound</th>#}
{#        </tr>#}
{#        <tr>#}
{#            <td colspan="2">{{ form.compound }}</td>#}
{#        </tr>#}
{#        <tr>#}
{#            <th>Supplier</th>#}
{#            <th>Lot</th>#}
{#        </tr>#}
{#        <tr>#}
{#            <td>{{ form.supplier_text }}</td>#}
{#            <td>{{ form.lot_text }}</td>#}
{#        </tr>#}
{#        <tr>#}
{#            <th colspan="2">Receipt Date</th>#}
{#        </tr>#}
{#        <tr>#}
{#            <td colspan="2">{{ form.receipt_date }}</td>#}
{#        </tr>#}
{#    </table>#}
    <table class="table table-condensed table-bordered table-nonfluid no-margin-bottom">
    <tr>
        <th>Compound*</th>
        <th>Supplier*</th>
        <th>Lot*</th>
        <th>Receipt Date</th>
    </tr>
    <tr>
        <td>{{ form.compound }}</td>
        <td>{{ form.supplier_text }}</td>
        <td>{{ form.lot_text }}</td>
        <td>{{ form.receipt_date }}</td>
    </tr>
    </table>
    <table class="table table-condensed table-bordered table-nonfluid no-margin-bottom">
        <tr>
            <th>Concentration*</th>
            <th>Concentration Unit*</th>
        </tr>
        <tr>
            <td>{{ form.concentration }}</td>
            <td>{{ form.concentration_unit }}</td>
        </tr>
        <tr>
            <th>Concentration Increment</th>
            <th>Increment Operation</th>
        </tr>
        <tr>
            <td>{{ form.concentration_increment }}</td>
            <td>{{ form.concentration_increment_type }}</td>
        </tr>
        <tr>
            <td colspan="2">{{ form.concentration_increment_direction }}</td>
        </tr>
    </table>
    <table class="table table-condensed table-bordered table-nonfluid no-margin-bottom">
        <tr>
            <th class="bg-success" colspan="3">Addition Time*</th>
            <th class="bg-info" colspan="3">Duration*</th>
        </tr>
        <tr>
            <th class="bg-success">Day</th>
            <th class="bg-success">Hour</th>
            <th class="bg-success">Minute</th>
            <th class="bg-info">Day</th>
            <th class="bg-info">Hour</th>
            <th class="bg-info">Minute</th>
        </tr>
        <tr>
            <td class="bg-success">{{ form.addition_time_day }}</td>
            <td class="bg-success">{{ form.addition_time_hour }}</td>
            <td class="bg-success">{{ form.addition_time_minute }}</td>
            <td class="bg-info">{{ form.duration_day }}</td>
            <td class="bg-info">{{ form.duration_hour }}</td>
            <td class="bg-info">{{ form.duration_minute }}</td>
        </tr>
    </table>
{#    <table class="table table-condensed table-bordered table-nonfluid no-margin-bottom">#}
{#        <tr>#}
{#            <th>Compound</th>#}
{#            <th>Supplier</th>#}
{#            <th>Lot</th>#}
{#            <th>Receipt Date</th>#}
{#        </tr>#}
{#        <tr>#}
{#            <td>{{ form.compound }}</td>#}
{#            <td>{{ form.supplier_text }}</td>#}
{#            <td>{{ form.lot_text }}</td>#}
{#            <td>{{ form.receipt_date }}</td>#}
{#        </tr>#}
{#    </table>#}
{#    <table class="table table-condensed table-bordered table-nonfluid no-margin-bottom">#}
{#        <tr>#}
{#            <th>Concentration</th>#}
{#            <th>Concentration Unit</th>#}
{#        </tr>#}
{#        <tr>#}
{#            <td>{{ form.concentration }}</td>#}
{#            <td>{{ form.concentration_unit }}</td>#}
{#        </tr>#}
{#    </table>#}
{#    <table class="table table-condensed table-bordered table-nonfluid no-margin-bottom">#}
{#        <tr>#}
{#            <th class="bg-success" colspan="3">Addition Time</th>#}
{#            <th class="bg-info" colspan="3">Duration</th>#}
{#        </tr>#}
{#        <tr>#}
{#            <th class="bg-success">Day</th>#}
{#            <th class="bg-success">Hour</th>#}
{#            <th class="bg-success">Minute</th>#}
{#            <th class="bg-info">Day</th>#}
{#            <th class="bg-info">Hour</th>#}
{#            <th class="bg-info">Minute</th>#}
{#        </tr>#}
{#        <tr>#}
{#            <td class="bg-success">{{ form.addition_time_day }}</td>#}
{#            <td class="bg-success">{{ form.addition_time_hour }}</td>#}
{#            <td class="bg-success">{{ form.addition_time_minute }}</td>#}
{#            <td class="bg-info">{{ form.duration_day }}</td>#}
{#            <td class="bg-info">{{ form.duration_hour }}</td>#}
{#            <td class="bg-info">{{ form.duration_minute }}</td>#}
{#        </tr>#}
{#        <tr>#}
{#            <th class="bg-success" colspan="3">Addition Time Increment</th>#}
{#            <th class="bg-info" colspan="3">Duration Increment</th>#}
{#        </tr>#}
{#        <tr>#}
{#            <th class="bg-success">Day</th>#}
{#            <th class="bg-success">Hour</th>#}
{#            <th class="bg-success">Minute</th>#}
{#            <th class="bg-info">Day</th>#}
{#            <th class="bg-info">Hour</th>#}
{#            <th class="bg-info">Minute</th>#}
{#        </tr>#}
{#        <tr>#}
{#            <td class="bg-success">{{ form.addition_time_day_increment }}</td>#}
{#            <td class="bg-success">{{ form.addition_time_hour_increment }}</td>#}
{#            <td class="bg-success">{{ form.addition_time_minute_increment }}</td>#}
{#            <td class="bg-info">{{ form.duration_day_increment }}</td>#}
{#            <td class="bg-info">{{ form.duration_hour_increment }}</td>#}
{#            <td class="bg-info">{{ form.duration_minute_increment }}</td>#}
{#        </tr>#}
{#    </table>#}
    </div>
    </div>

{#    {% include 'generic_field.html' with field=form.increment label="Increment Amount" %}#}
{#    {% include 'generic_field.html' with field=form.increment_type label="Increment Type" %}#}
{#    {% include 'generic_field.html' with field=form.increment_direction label="Increment Direction" %}#}
    </div>

    <div hidden id="add_cells_section" class="item-section">
{#    {% include 'generic_field.html' with field=form.cell_sample label="Cell Sample" %}#}
    <div class="form-group">
    <label for="cell_sample" class="col-sm-2 control-label">Cell Sample*</label>
    <div class="col-sm-10">
        <input readonly=true id="id_cell_sample" name="cell_sample" size="5" value={{ form.cell_sample.value|default_if_none:'' }}>
        <button id='id_cell_sample_search' type="button" class="btn btn-xs btn-info">
            <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
        </button>
        <label class="small" id="id_cell_sample_label"></label>
    </div>
    </div>
    {% include 'generic_field.html' with field=form.biosensor label="Biosensor*" %}
    {% include 'generic_field.html' with field=form.density label="Density*" %}
    {% include 'generic_field.html' with field=form.density_unit label="Density Unit*" %}
    {% include 'generic_field.html' with field=form.passage label="Passage" %}
    </div>

{#    <div hidden id="incrementer_section" class="item-section">#}
{#    {% include 'generic_field.html' with field=form.increment label="Increment Amount" %}#}
{#    {% include 'generic_field.html' with field=form.increment_type label="Increment Type" %}#}
{#    {% include 'generic_field.html' with field=form.increment_direction label="Increment Direction" %}#}
{#    </div>#}

    </div>

    </form>

    <div class="padded-bottom">
    <div id="matrix_wrapper" class="overflow-auto" style="max-height:800px;">
        {# NO INLINE STYLE PLEASE #}
        <table id="matrix_table" class="table ">
            <tbody id="matrix_body"></tbody>
        </table>
    </div>
    </div>

    {# Cellsample Selection Stuff #}
    <div hidden id="dialog" title="Choose a Cell Sample">
        <div class="alert alert-info text-center" role="alert">
            <button role="button" class="btn btn-danger" id="clear_cell_sample">Clear Cell Sample</button>
        </div>

        <table id="cellsamples" class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Select</th>
                        <th>ID #</th>
                        <th>Receipt Date</th>
                        <th>Cell Type</th>
                        <th>Cell Origin</th>
                        <th>Supplier</th>
                        <th>Barcode/Lot#</th>
                        <th>Patient</th>
                    </tr>
                </thead>

                <tbody>
                {% for cellsample in cellsamples %}
                    <tr class="cellsample">
                        <td>
                            <button type="button" class="cellsample-selector btn btn-xs btn-primary" id={{ cellsample.id }} name="{{ cellsample }}">Select</button>
                        </td>
                        <td>{{ cellsample.id }}</td>
                        <td>{{ cellsample.receipt_date|date:"M d, Y" }}</td>
                        <td>{{ cellsample.cell_type }}</td>
                        <td>{{ cellsample.cell_subtype }}</td>
                        <td>{{ cellsample.supplier }}</td>
                        <td>{{ cellsample.barcode }}</td>
                        <td>
                            {% if cellsample.patient_age or cellsample.patient_gender != 'N' or cellsample.patient_condition %}
                                {{ cellsample.patient_age|default:"Unknown" }} year old {{ cellsample.patient_gender }}
                                {{ cellsample.patient_condition }}
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
        </table>
    </div>
{% endblock %}
