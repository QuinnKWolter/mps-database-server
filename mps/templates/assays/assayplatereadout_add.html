{% extends "base.html" %}
{% load static %}

{% block load %}
    <link href="{% static "assays/customize_admin.css" %}" rel="stylesheet" type="text/css">
    <script src="{% static "js/inline_add.js" %}"></script>
    <script src="{% static "js/enter_override.js" %}"></script>
    <script src="{% static "js/flag.js" %}"></script>
    <script src="{% static "assays/plate_display.js" %}"></script>
    <script src="{% static "assays/customize_plate_readout.js" %}"></script>
    <script src="{% static "js/help.js" %}"></script>
{% endblock %}

{% block breadcrumbs %}
    <li><a href="/assays/group_index/">Group Studies</a></li>
    <li>
        {% if object %}
            <a href="/assays/{{ object.setup.assay_run_id.id }}">{{ object.setup.assay_run_id }}</a>
        {% else %}
            <a href="/assays/{{ study.id }}">{{ study }}</a>
        {% endif %}
    </li>
    <li class="active">
        {% if object %}
            Edit Readout for <em>Plate-{{ object.setup.assay_plate_id }}</em>
        {% else %}
            Add Plate Readout
        {% endif %}
    </li>
{% endblock %}

{% block fluid-content %}
{% if update %}
    <form onsubmit="return confirm('Are you sure you want to overwrite this entry?');" enctype="multipart/form-data" class="form-horizontal" method="post" >

    <div class="container">

    {% include 'review.html' %}

    <h1>
        Edit Readout for <em>{{ object.setup }}</em>
{% else %}
    <form enctype="multipart/form-data" class="form-horizontal" method="post" >

    <div class="container">
    <h1>
        Add Plate Readout
{% endif %}
    <br>
    {% csrf_token %}

{#        <button id="submit" type="submit" class="btn btn-primary" onclick="$('#id_another').val(false);">Submit</button>#}
{##}
{#        {% if not update %}#}
{#            <button type="submit" class="btn btn-info" onclick="$('#id_another').val(true);">Submit and Clone</button>#}
{#        {% endif %}#}
{##}
{#        {% if update %}#}
{#            <a role="button" class="btn btn-info" href="/assays/{{ object.setup.assay_run_id.id }}/assayplatereadout/add?clone={{ object.id }}">Clone</a>#}
{#            <a role="button" class="btn btn-danger pull-right readjust-pulled" href="/assays/assayplatereadout/{{ object.id }}/delete/">Delete</a>#}
{#        {% endif %}#}
{##}
{#        {% include 'flag.html'%}#}
    </h1>

    {% include "submit.html" with flag="y" clone="y" help="y" %}

    {% include 'errors.html' %}

    {% if form.success.value %}
        <div class="alert alert-success" role="alert">
            <span class="glyphicon glyphicon-ok" aria-hidden="true"></span>
            <span class="sr-only">Success:</span>
            Successful Submission and Clone
        </div>
    {% endif %}

    {% include 'tracking.html' %}

    {# Hidden: Used to indicate submit and clone #}
    {{ form.another.as_hidden }}

    <legend>Readout Details</legend>

    {% if form.setup.errors %}
        {% for error in form.setup.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="setup" class="col-sm-2 control-label">Setup*</label>
        <div class="col-sm-10">
          {{ form.setup }}
        </div>
    </div>

    {% if form.readout_start_time.errors %}
        {% for error in form.readout_start_time.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="readout_start_time" class="col-sm-2 control-label">Readout Start Date*</label>
        <div class="col-sm-10">
          {{ form.readout_start_time }} [yyyy-mm-dd]
        </div>
    </div>

    {% if form.timeunit.errors %}
        {% for error in form.timeunit.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="timeunit" class="col-sm-2 control-label">Treatment Time Unit*</label>
        <div class="col-sm-10">
          {{ form.timeunit }}
        </div>
    </div>

    {% if form.treatment_time_length.errors %}
        {% for error in form.treatment_time_length.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="treatment_time_length" class="col-sm-2 control-label">Total Treatment Time</label>
        <div class="col-sm-10">
          {{ form.treatment_time_length }}
        </div>
    </div>

    <div class="form-group">
        <label for="scientist" class="col-sm-2 control-label">Scientist</label>
        <div class="col-sm-10">
          {{ form.scientist }}
        </div>
    </div>

    {% if form.notebook_page.errors %}
        {% for error in form.notebook_page.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="notebook" class="col-sm-2 col-md-2 control-label">Notebook</label>
        <div class="col-sm-3 col-md-2">
            {{ form.notebook }}
         </div>
        <label for="notebook_page" class="col-sm-3 col-md-2 control-label">Notebook Page</label>
        <div class="col-sm-4 col-md-6">
            {{ form.notebook_page }}
        </div>
    </div>

    <div class="form-group">
        <label for="notes" class="col-sm-2 control-label">Notes</label>
        <div class="col-sm-10">
          {{ form.notes }}
        </div>
    </div>

    {% if form.file.errors %}
        {% for error in form.file.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="file" class="col-sm-2 control-label">.csv Data File</label>
        <div class="col-sm-10">
          {{ form.file }}
            <p>
                <b>***Uploading overwrites old data***</b>
            </p>
        </div>
    </div>

    {# Upload type indicates whether tabular or block #}
    <div class="form-group">
        <label for="upload_type" class="col-sm-2 control-label">Upload Type*</label>
        <div class="col-sm-10">
          {{ form.upload_type }}
        </div>
    </div>

    {{ formset.management_form }}
    <legend>Assays</legend>

    {% if formset.non_form_errors %}
        <div class="alert alert-danger" role="alert">
            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
            <span class="sr-only">Error:</span>
            {{ formset.non_form_errors }}
        </div>
    {% endif %}

    {% if formset.errors %}
        {% for dict in formset.errors %}
            {% for key,value in dict.items %}
                {% if key %}
                    <div class="alert alert-danger" role="alert">
                        <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                        <span class="sr-only">Error:</span>
                        {{ forloop.parentloop.counter }}.) {{ key }} : {{ value }}
                    </div>
                {% endif %}
            {% endfor %}
        {% endfor %}
    {% endif %}

    <table hidden class="table table-striped" id="binding">
        <thead>
            <tr>
                <th>Feature</th>
                <th>Assay</th>
            </tr>
        </thead>
        <tbody id="binding_table">
        </tbody>
    </table>

    <p class="text-danger">
        <b>You do not need to manually type features: Use the interface that appears above after upload.</b>
    </p>
    <a id="add_button" class="btn btn-success" role="button">Add Assay</a>

    <table class="table table-striped assays" id="assayplatereadoutassay_set-group"  name="inlines">
        <thead>
            <tr>
                <th>Assay</th>
                <th>Reader</th>
                <th>Readout Unit</th>
                <th>Feature</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody>
            {% for assay in formset %}
                <tr class="inline" id="assay-{{ forloop.counter0 }}">
                    {# Hidden input for Update (need id to associate) #}
                    {% if assay.id.value %}
                    <td class="original" hidden>
                        <input id="id_assayplatereadoutassay_set-{{ forloop.counter0 }}-id" name="assayplatereadoutassay_set-{{ forloop.counter0 }}-id" type="hidden" value="{{ assay.id.value }}">
                    </td>
                    {% endif %}
                    <td>{{ assay.assay_id }}</td>
                    <td>{{ assay.reader_id }}</td>
                    <td>{{ assay.readout_unit }}</td>
                    <td>{{ assay.feature }}</td>
                    <td>{{ assay.DELETE }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    </div>

    {# CONTRIVED: REFACTOR SOON #}
    <div class="fancy-checkbox form-group" style="padding-left:40px;">
        <input type="checkbox" id="qc_mode" />
        <div class="btn-group" style="min-width: 550px;">
            <label for="qc_mode" class="btn btn-danger">
                <span class="glyphicon glyphicon-ok"></span>
                <span> </span>
            </label>
            <label for="qc_mode" class="btn btn-default active">
                Click Wells to Invalidate/Validate Them <small>(click here to toggle this function on and off)</small>
            </label>
        </div>
    </div>

    <div class="padded-row">
        <div hidden id="heatmap_options" class="inline-group row">
            <div class="col-sm-8">
                <div class="col-sm-2 col-lg-2">
                    <label for="assay_select">Select Assay</label>
                </div>
                <div class="col-sm-6 col-lg-4">
                    <select id="assay_select"></select>
                </div>
                <div id="time_select_row">
                    <div class="col-sm-2 col-lg-2">
                        <label for="time_select">Select Time</label>
                    </div>
                    <div class="col-sm-2 col-lg-2">
                        <select id="time_select"></select>
                    </div>
                </div>
            </div>
            <div class="col-sm-4">
                <div class="col-xs-12">
                    <button type="button" id="data_toggle">Toggle Data Only</button>
                </div>
            </div>
        </div>

        <br>

        <div id="heatmap_legend">
            <svg width="630" height="40">
                <g>
                    <g class="legend">
                        <rect x="0" y="0" width="30" height="10" style="fill: rgb(0, 128, 0);"></rect>
                        <text fill="black" x="0" y="25">Low</text>
                    </g>
                    <g class="legend">
                        <rect x="30" y="0" width="30" height="10" style="fill: rgb(26, 140, 0);"></rect>
                    </g>
                    <g class="legend">
                        <rect x="60" y="0" width="30" height="10" style="fill: rgb(51, 152, 0);"></rect>
                    </g>
                    <g class="legend">
                        <rect x="90" y="0" width="30" height="10" style="fill: rgb(77, 164, 0);"></rect>
                    </g>
                    <g class="legend">
                        <rect x="120" y="0" width="30" height="10" style="fill: rgb(102, 176, 0);"></rect>
                    </g>
                    <g class="legend">
                        <rect x="150" y="0" width="30" height="10" style="fill: rgb(128, 188, 0);"></rect>
                    </g>
                    <g class="legend">
                        <rect x="180" y="0" width="30" height="10" style="fill: rgb(153, 200, 0);"></rect>
                    </g>
                    <g class="legend">
                        <rect x="210" y="0" width="30" height="10" style="fill: rgb(179, 212, 0);"></rect>
                    </g>
                    <g class="legend">
                        <rect x="240" y="0" width="30" height="10" style="fill: rgb(204, 224, 0);"></rect>
                    </g>
                    <g class="legend">
                        <rect x="270" y="0" width="30" height="10" style="fill: rgb(230, 236, 0);"></rect>
                    </g>
                    <g class="legend">
                        <rect x="300" y="0" width="30" height="10" style="fill: rgb(255, 255, 0);"></rect>
                    </g>
                    <g class="legend">
                        <rect x="330" y="0" width="30" height="10" style="fill: rgb(243, 230, 0);"></rect>
                    </g>
                    <g class="legend">
                        <rect x="360" y="0" width="30" height="10" style="fill: rgb(231, 204, 0);"></rect>
                    </g>
                    <g class="legend">
                        <rect x="390" y="0" width="30" height="10" style="fill: rgb(219, 179, 0);"></rect>
                    </g>
                    <g class="legend">
                        <rect x="420" y="0" width="30" height="10" style="fill: rgb(207, 153, 0);"></rect>
                    </g>
                    <g class="legend">
                        <rect x="450" y="0" width="30" height="10" style="fill: rgb(195, 128, 0);"></rect>
                    </g>
                    <g class="legend">
                        <rect x="480" y="0" width="30" height="10" style="fill: rgb(183, 102, 0);"></rect>
                    </g>
                    <g class="legend">
                        <rect x="510" y="0" width="30" height="10" style="fill: rgb(171, 77, 0);"></rect>
                    </g>
                    <g class="legend">
                        <rect x="540" y="0" width="30" height="10" style="fill: rgb(159, 51, 0);"></rect>
                    </g>
                    <g class="legend">
                        <rect x="570" y="0" width="30" height="10" style="fill: rgb(147, 26, 0);"></rect>
                    </g>
                    <g class="legend">
                        <rect x="600" y="0" width="30" height="10" style="fill: rgb(135, 0, 0);"></rect>
                        <text fill="black" x="600" y="25">High</text>
                    </g>
                </g>
            </svg>
        </div>
    </div>
</form>

<div hidden id="help_dialog" title="Plate Readout Help">
    <h4>Uploading Data</h4>
    <ul class="list-group">
        <li class="list-group-item">
            <h4>You may choose between <b>Block</b> and <b>Tabular</b> formats</h4>
        </li>
        <li class="list-group-item">
            <h4>A theoretical 3x2 6-well plate in <b>Block</b> format would be as follows:</h4>
            <table class="table table-bordered small" style="background-color: #F0FFFF;">
                <thead>
                    <tr class="active">
                        <th>Plate ID</th>
                        <th>[Plate ID]</th>
                        <th>Assay</th>
                        <th>[Assay 1]</th>
                        <th>Feature</th>
                        <th>[Feature 1]</th>
                        <th>Value Unit</th>
                        <th>[Value Unit 1]</th>
                        <th>Time*</th>
                        <th>[Time 1]*</th>
                        <th>Time Units*</th>
                        <th>[Time Unit 1]*</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>[Val 1]</td>
                        <td>[Val 2]</td>
                        <td>[Val 3]</td>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <td>[Val 4]</td>
                        <td>[Val 5]</td>
                        <td>[Val 6]</td>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr class="active">
                        <th>Plate ID</th>
                        <th>[Plate ID]</th>
                        <th>Assay</th>
                        <th>[Assay 2]</th>
                        <th>Feature</th>
                        <th>[Feature 2]</th>
                        <th>Value Unit</th>
                        <th>[Value Unit 2]</th>
                        <th>Time*</th>
                        <th>[Time 2]*</th>
                        <th>Time Units*</th>
                        <th>[Time Unit 2]*</th>
                    </tr>
                    <tr>
                        <td>[Val 7]</td>
                        <td>[Val 8]</td>
                        <td>[Val 9]</td>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <td>[Val 10]</td>
                        <td>[Val 11]</td>
                        <td>[Val 12]</td>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                </tbody>
            </table>
            *Optional (if not using time, totally exclude cells)
        </li>
        <li class="list-group-item">
            <h4>The above example in <b>Tabular</b> format would be as follows:</h4>
            <table class="table table-bordered small" style="background-color: #F0FFFF;">
                <thead>
                    <tr class="active">
                        <th>Plate ID</th>
                        <th>Well ID</th>
                        <th>Assay</th>
                        <th>Feature</th>
                        <th>Value Unit</th>
                        <th>Time*</th>
                        <th>Time Units*</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>[Plate ID]</td>
                        <td>A1</td>
                        <td>[Assay 1]</td>
                        <td>[Feature 1]</td>
                        <td>[Value Unit 1]</td>
                        <td>[Time 1]*</td>
                        <td>[Time Unit 1]*</td>
                        <td>[Val 1]</td>
                    </tr>
                    <tr>
                        <td>[Plate ID]</td>
                        <td>A2</td>
                        <td>[Assay 1]</td>
                        <td>[Feature 1]</td>
                        <td>[Value Unit 1]</td>
                        <td>[Time 1]*</td>
                        <td>[Time Unit 1]*</td>
                        <td>[Val 2]</td>
                    </tr>
                    <tr>
                        <td>[Plate ID]</td>
                        <td>A3</td>
                        <td>[Assay 1]</td>
                        <td>[Feature 1]</td>
                        <td>[Value Unit 1]</td>
                        <td>[Time 1]*</td>
                        <td>[Time Unit 1]*</td>
                        <td>[Val 3]</td>
                    </tr>
                    <tr>
                        <td>[Plate ID]</td>
                        <td>B1</td>
                        <td>[Assay 1]</td>
                        <td>[Feature 1]</td>
                        <td>[Value Unit 1]</td>
                        <td>[Time 1]*</td>
                        <td>[Time Unit 1]*</td>
                        <td>[Val 4]</td>
                    </tr>
                    <tr>
                        <td>[Plate ID]</td>
                        <td>B2</td>
                        <td>[Assay 1]</td>
                        <td>[Feature 1]</td>
                        <td>[Value Unit 1]</td>
                        <td>[Time 1]*</td>
                        <td>[Time Unit 1]*</td>
                        <td>[Val 5]</td>
                    </tr>
                    <tr>
                        <td>[Plate ID]</td>
                        <td>B3</td>
                        <td>[Assay 1]</td>
                        <td>[Feature 1]</td>
                        <td>[Value Unit 1]</td>
                        <td>[Time 1]*</td>
                        <td>[Time Unit 1]*</td>
                        <td>[Val 6]</td>
                    </tr>
                    <tr>
                        <td>[Plate ID]</td>
                        <td>A1</td>
                        <td>[Assay 2]</td>
                        <td>[Feature 2]</td>
                        <td>[Value Unit 2]</td>
                        <td>[Time 2]*</td>
                        <td>[Time Unit 2]*</td>
                        <td>[Val 7]</td>
                    </tr>
                    <tr>
                        <td>[Plate ID]</td>
                        <td>A2</td>
                        <td>[Assay 2]</td>
                        <td>[Feature 2]</td>
                        <td>[Value Unit 2]</td>
                        <td>[Time 2]*</td>
                        <td>[Time Unit 2]*</td>
                        <td>[Val 8]</td>
                    </tr>
                    <tr>
                        <td>[Plate ID]</td>
                        <td>A3</td>
                        <td>[Assay 2]</td>
                        <td>[Feature 2]</td>
                        <td>[Value Unit 2]</td>
                        <td>[Time 2]*</td>
                        <td>[Time Unit 2]*</td>
                        <td>[Val 9]</td>
                    </tr>
                    <tr>
                        <td>[Plate ID]</td>
                        <td>B1</td>
                        <td>[Assay 2]</td>
                        <td>[Feature 2]</td>
                        <td>[Value Unit 2]</td>
                        <td>[Time 2]*</td>
                        <td>[Time Unit 2]*</td>
                        <td>[Val 10]</td>
                    </tr>
                    <tr>
                        <td>[Plate ID]</td>
                        <td>B2</td>
                        <td>[Assay 2]</td>
                        <td>[Feature 2]</td>
                        <td>[Value Unit 2]</td>
                        <td>[Time 2]*</td>
                        <td>[Time Unit 2]*</td>
                        <td>[Val 11]</td>
                    </tr>
                    <tr>
                        <td>[Plate ID]</td>
                        <td>B3</td>
                        <td>[Assay 2]</td>
                        <td>[Feature 2]</td>
                        <td>[Value Unit 2]</td>
                        <td>[Time 2]*</td>
                        <td>[Time Unit 2]*</td>
                        <td>[Val 12]</td>
                    </tr>
                </tbody>
            </table>
            *Optional (if not using time, totally exclude columns)
        </li>
        <li class="list-group-item">
            File uploads can use either full names ("Albumin") or abbreviations ("ALB") for assays
        </li>
        <li class="list-group-item">
            <b class="text-danger">
                <span class="glyphicon glyphicon-exclamation-sign"></span>
                The brackets ([] and {}) in the above examples and templates are not meant to be taken literally
                <br>
                When you are actually entering data, remove them
            </b>
        </li>
        <li class="list-group-item">
            <b class="text-danger">
                <span class="glyphicon glyphicon-exclamation-sign"></span>
                The Plate ID should be nothing more than the Plate ID/Barcode you entered in the setup
                <br>
                i.e. do not include "Plate-" at the beginning of the Plate ID
            </b>
        </li>
        <li class="list-group-item">
            <b class="text-danger">
                <span class="glyphicon glyphicon-exclamation-sign"></span>
                Always start in the top-left corner (the first cell)
            </b>
        </li>
        <li class="list-group-item">
            <b class="text-danger">
                <span class="glyphicon glyphicon-exclamation-sign"></span>
                Uploading overwrites previous data
            </b>
        </li>
        <li class="list-group-item">
            <b class="text-danger">
                <span class="glyphicon glyphicon-exclamation-sign"></span>
                You will have to reselect the desired file after a failed submission
            </b>
        </li>
    </ul>
    <h4>Changing QC</h4>
    <ul class="list-group">
        <li class="list-group-item">
            <b>
                In the .csv file you can change a value's QC status by putting a <i>single letter</i> in front of the value
                <br>
                (e.g. to invalidate the value "12.3" put "x12.3" in the cell instead)
            </b>
        </li>
        <li class="list-group-item">
            Clicking
            <br>
            <div class="fancy-checkbox form-group">
                <input type="checkbox" />
                <div class="btn-group" style="min-width: 550px;">
                    <label class="btn btn-danger">
                        <span class="glyphicon glyphicon-ok"></span>
                        <span> </span>
                    </label>
                    <label class="btn btn-default active">
                        Click Wells to Invalidate/Validate Them <small>(click here to toggle this function on and off)</small>
                    </label>
                </div>
            </div>
            will toggle whether or not you can invalidate wells by clicking on the displayed heatmap
        <li class="list-group-item">
            To invalidate a reading, click the corresponding well (granted the above button is on)
        </li>
        <li class="list-group-item">
            Invalidated wells will be greyed out and their values put in red
        </li>
    </ul>
    <h4>Flagging for Review</h4>
    <ul class="list-group">
        <li class="list-group-item">
            Clicking
            <a role='button' class="btn btn-sm" style="color:#337AB7">
                <span class="glyphicon glyphicon-flag" aria-hidden="true"></span>
            </a>
            flags the current readout for review
        </li>
        <li class="list-group-item">
            Clicking
            <a role='button' class="btn btn-sm btn-warning" style="color:#FFFFFF">
                Notes
            </a>
            brings up an input dialog where you can explain why this readout was flagged
        </li>
        <li class="list-group-item">
            Clicking
            <a role='button' class="btn btn-sm btn-danger" style="color:#FFFFFF">
                <span class="glyphicon glyphicon-flag" aria-hidden="true"></span>
            </a>
            removes the flag from the current readout
        </li>
    </ul>
</div>
{% endblock %}
