{% extends "base.html" %}
{% load static %}

{% block load %}
    <script src="{% static "js/inline_add.js" %}"></script>
    <script src="{% static "js/cookies.js" %}"></script>
    <script src="{% static "assays/customize_chip.js" %}"></script>
    <script src="{% static "js/enter_override.js" %}"></script>
    <script src="{% static "js/flag.js" %}"></script>
{% endblock %}

{% block content %}

<style>
.layout-table th {
    border: 1px solid black;
    padding: 2px;
}
</style>

<script>
    $(function() {
        var date = $("#id_readout_start_time");
        var curr_date = date.val();
        //Add datepicker to assay and readout start time
        date.datepicker();
        date.datepicker("option","dateFormat","yy-mm-dd");
        date.datepicker("setDate" , curr_date);
    });
</script>

{# The presence of this hidden div tells the inline add script to change its delete behavior #}
{#{% if update %}#}
{#    <div hidden id="update"></div>#}
{#{% endif %}#}

{% if update %}
    <form onsubmit="return confirm('Are you sure you want to overwrite this entry?');" enctype="multipart/form-data" class="form-horizontal" method="post" >
{% else %}
    <form enctype="multipart/form-data" class="form-horizontal" method="post" >
{% endif %}
    {% csrf_token %}
    <h1>
        Chip Readout

        <button id="submit" type="submit" class="btn btn-primary" onclick="$('#id_another').val(false);">Submit</button>

        {% if not update %}
            <button type="submit" class="btn btn-info" onclick="$('#id_another').val(true);">Submit and Clone</button>
        {% endif %}

        {# Html for flagging for review #}
        {% if form.flagged.value %}
            {# If the model is flagged then display a danger flag and the notes #}
            <a role='button' id="flag" class="btn btn-sm btn-danger" title="Flag for review">
                <span class="glyphicon glyphicon-flag" aria-hidden="true"></span>
            </a>
            <a role='button' id="notes_for_flag" class="btn btn-sm btn-warning" title="Reason for Flag">
                Notes
            </a>
        {% else %}
            {# If the model is not flagged display a blue flag and no notes #}
            <a role='button' id="flag" class="btn btn-sm" title="Flag for review">
                <span class="glyphicon glyphicon-flag" aria-hidden="true"></span>
            </a>
            <a role='button' id="notes_for_flag" class="btn btn-sm btn-warning" title="Reason for Flag" style="display: none">
                Notes
            </a>
        {% endif %}

        {% if update %}
            <a role="button" class="btn btn-danger pull-right" href="/assays/assaychipreadout/{{ object.id }}/delete/">Delete</a>
        {% endif %}

        <div class="form-group has-error">
            <input class='small form-control' placeholder="Reason for Flag" id="id_reason_for_flag" maxlength="300"
            name="reason_for_flag" type="text" style="display: none;" value="{{ form.reason_for_flag.value|default:'' }}">
        </div>
    </h1>

    {% if form.another.value and form.is_valid and formset.is_valid %}
        <div class="alert alert-success" role="alert">
            <span class="glyphicon glyphicon-ok" aria-hidden="true"></span>
            <span class="sr-only">Success:</span>
            Successful Submission and Clone
        </div>
    {% endif %}

    {# Hidden: Used to indicate submit and clone #}
    {{ form.another.as_hidden }}

    {# Hidden div for flagging the entry #}
    <div hidden>
        {{ form.flagged }}
    </div>

    <legend>Readout Details</legend>
{#    <p>Setup: {{ form.chip_setup }}</p>#}
{#    <p>Time Unit: {{ form.timeunit }}</p>#}
{#    <p>Treatment Time Length: {{ form.treatment_time_length }}</p>#}
{#    <p>Assay Start Time: {{ form.assay_start_time }}</p>#}
{#    <p>Readout Start Time: {{ form.readout_start_time }}</p>#}
{#    <p>Notebook: {{ form.notebook }}</p>#}
{#    <p>Notebook Page: {{ form.notebook_page }}</p>#}
{#    <p>Notes: {{ form.notes }}</p>#}
{#    <p>File: {{ form.file }}</p>#}

    {% if form.chip_setup.errors %}
        {% for error in form.chip_setup.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="chip_setup" class="col-sm-2 control-label">Setup*</label>
        <div class="col-sm-10">
          <select id="id_chip_setup" name="chip_setup">
            <option value="">---------</option>
            {% for setup in setups %}
              {# It is necessary to coerce the forms value into an integer for this compare #}
              {% if setup.id|add:"0" == form.chip_setup.value|add:"0" %}
                <option value={{ setup.id }} selected>{{ setup }}</option>
              {% else %}
                <option value={{ setup.id }}>{{ setup }}</option>
              {% endif %}
            {% endfor %}
          </select>
        </div>
    </div>

    {% if form.readout_start_time.errors %}
        {% for error in form.readout_start_time.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="readout_start_time" class="col-sm-2 control-label">Readout Start Date*</label>
        <div class="col-sm-10">
          {{ form.readout_start_time }} [yyyy-mm-dd]
        </div>
    </div>

    {% if form.timeunit.errors %}
        {% for error in form.timeunit.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="timeunit" class="col-sm-2 control-label">Time Unit*</label>
        <div class="col-sm-10">
          {{ form.timeunit }}
        </div>
    </div>

    {% if form.treatment_time_length.errors %}
        {% for error in form.treatment_time_length.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="treatment_time_length" class="col-sm-2 control-label">Treatment Time Length</label>
        <div class="col-sm-10">
          {{ form.treatment_time_length }}
        </div>
    </div>

    {% if form.notebook_page.errors %}
        {% for error in form.notebook_page.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="notebook" class="col-sm-2 control-label">Notebook</label>
        <div class="col-sm-10">
            {{ form.notebook }}
            <label for="notebook_page" style="padding-left: 20px;padding-right: 10px;">Notebook Page</label>
            {{ form.notebook_page }}
        </div>
    </div>

    <div class="form-group">
        <label for="notes" class="col-sm-2 control-label">Notes</label>
        <div class="col-sm-10">
          {{ form.notes }}
        </div>
    </div>

{#    <div class="form-group">#}
{#        <label for="group" class="col-sm-2 control-label">Group</label>#}
{#        <div class="col-sm-10">#}
{#          {{ form.group }}#}
{#        </div>#}
{#    </div>#}

    {% if form.file.errors %}
        {% for error in form.file.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="file" class="col-sm-2 control-label">.csv Data File</label>
        <div class="col-sm-10">
          {{ form.file }}
            <p><b>***Uploading overwrites old data***</b>
            Rows in <span style="color: #FF0000">red</span> will be excluded.
            Rows in <span style="color: #00FF00">green</span> are in the database.
            </p>
        </div>
    </div>

{#    {% if form.headers.errors %}#}
{#        {% for error in form.headers.errors %}#}
{#            <div class="alert alert-danger" role="alert">#}
{#                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>#}
{#                <span class="sr-only">Error:</span>#}
{#                {{error}}#}
{#            </div>#}
{#        {% endfor %}#}
{#    <div class="form-group has-error">#}
{#    {% else %}#}
    <div class="form-group">
{#    {% endif %}#}
        <label for="headers" class="col-sm-2 control-label">Number of Header Rows</label>
        <div class="col-sm-10">
          <input id="id_headers" type="number" name="headers" style="width:50px;" value="{{ form.headers.value|default:"1" }}">
        </div>
    </div>

    {{ formset.management_form }}
    <legend>Assays</legend>

    {% if formset.non_form_errors %}
        <div class="alert alert-danger" role="alert">
            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
            <span class="sr-only">Error:</span>
            {{ formset.non_form_errors }}
        </div>
    {% endif %}

    {% if formset.errors %}
        {% for dict in formset.errors %}
            {% for key,value in dict.items %}
                {% if key %}
                    <div class="alert alert-danger" role="alert">
                        <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                        <span class="sr-only">Error:</span>
                        {{ forloop.parentloop.counter }}.) {{ key }} : {{ value }}
                    </div>
                {% endif %}
            {% endfor %}
        {% endfor %}
    {% endif %}

    <a id="add_button" class="btn btn-success" role="button">Add Assay</a>
    <table class="table table-striped assays" id="assaychipreadoutassay_set-group"  name="inlines">
        <thead>
            <tr>
                <th>Assay</th>
                <th>Object of Interest</th>
                <th>Reader</th>
                <th>Readout Unit</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody>
            {% for assay in formset %}
                <tr class="inline" id="assay-{{ forloop.counter0 }}">
                    {# Hidden input for Update (need id to associate) #}
                    {% if assay.id.value %}
                    <td class="original" hidden>
                        <input id="id_assaychipreadoutassay_set-{{ forloop.counter0 }}-id" name="assaychipreadoutassay_set-{{ forloop.counter0 }}-id" type="hidden" value="{{ assay.id.value }}">
                    </td>
                    {% endif %}
                    <td>{{ assay.assay_id }}</td>
                    <td>{{ assay.object_type }}</td>
                    <td>{{ assay.reader_id }}</td>
                    <td>{{ assay.readout_unit }}</td>
                    <td>{{ assay.DELETE }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</form>

{% endblock %}
