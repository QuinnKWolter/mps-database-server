{% extends "base.html" %}
{% load static %}

{% block load %}
    <script src="{% static "js/inline_add.js" %}"></script>
    <script src="{% static "js/enter_override.js" %}"></script>
    <script src="{% static "assays/assaychipsetup_add.js" %}"></script>
    <script src="{% static "js/flag.js" %}"></script>
    <script src="{% static "js/help.js" %}"></script>
{% endblock %}

{% block breadcrumbs %}
    <li><a href="/assays/group_index/">Group Studies</a></li>
    <li>
        <a href="/assays/{{ form.instance.assay_run_id.id }}">{{ form.instance.assay_run_id }}</a>
    </li>
    <li class="active">
        {% if object %}
            Edit <em>{{ object }}</em>
        {% else %}
            Add Chip Setup
        {% endif %}
    </li>
{% endblock %}

{% block content %}
{% if update %}
    <form onsubmit="return confirm('Are you sure you want to overwrite this entry?');" class="form-horizontal" method="post">

    {% include 'review.html' %}

    <h1>
        Edit <em>{{ object }}</em>
{% else %}
    <form class="form-horizontal" method="post" >

    <h1>
        Add Chip Setup
{% endif %}
    <br>
    {% csrf_token %}

{#        <button id="submit" type="submit" class="btn btn-primary" onclick="$('#id_another').val(false);">Submit</button>#}
{##}
{#      Submit and Clone revised such that it is only in ADD; UPDATE will now give a link instead of submitting#}
{#      <button type="submit" class="btn btn-info" onclick="$('#id_another').val(true);">Submit and Clone</button>#}
{##}
{#        {% if not update %}#}
{#            <button type="submit" class="btn btn-info" onclick="$('#id_another').val(true);">Submit and Clone</button>#}
{#        {% endif %}#}
{##}
{#        {% if update %}#}
            {# Clone and Submit replaced by a simple hyperlink to the cloned add page #}
{#            <a role="button" class="btn btn-info" href="/assays/{{ object.assay_run_id.id }}/assaychipsetup/add?clone={{ object.id }}">Clone</a>#}
{#            <a role="button" class="btn btn-danger pull-right readjust-pulled" href="/assays/assaychipsetup/{{ object.id }}/delete/">Delete</a>#}
{#        {% endif %}#}
{##}
{#        {% include 'flag.html'%}#}
    </h1>

    {% include "submit.html" with flag="y" clone="y" help="y"%}

    {% include 'errors.html' %}

    {% if form.success.value %}
        <div class="alert alert-success" role="alert">
            <span class="glyphicon glyphicon-ok" aria-hidden="true"></span>
            <span class="sr-only">Success:</span>
            Successful Submission and Clone
        </div>
    {% endif %}

    {% include 'tracking.html' %}

    {# Hidden: Used to indicate submit and clone #}
    {{ form.another.as_hidden }}

    <legend>Chip Setup Details</legend>

    {% if form.setup_date.errors %}
        {% for error in form.setup_date.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="setup_date" class="col-sm-2 control-label">Setup Date*</label>
        <div class="col-sm-10">
          {{ form.setup_date }} [yyyy-mm-dd]
        </div>
    </div>

    {% if form.device.errors %}
        {% for error in form.device.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="device" class="col-sm-2 control-label">Device*</label>
        <div class="col-sm-10">
          {{ form.device }}
        </div>
    </div>

    {% if form.organ_model.errors %}
        {% for error in form.organ_model.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    <div id="organ_model_div" class="form-group has-error">
    {% else %}
    <div hidden id="organ_model_div" class="form-group">
    {% endif %}
        <label for="organ_model" class="col-sm-2 control-label">Organ Model</label>
        <div class="col-sm-10">
          {{ form.organ_model }}
        </div>
    </div>

    {% if form.organ_model_protocol.errors %}
        {% for error in form.organ_model_protocol.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    <div id="protocol_div" class="form-group has-error">
    {% else %}
    <div hidden id="protocol_div" class="form-group">
    {% endif %}
        <label for="organ_model_protocol" class="col-sm-2 control-label">Organ Model Protocol</label>
        <div class="col-sm-10">
          {{ form.organ_model_protocol }}
          <span>
            <a target="_blank" href="" id="protocol_display"></a>
          </span>
        </div>
    </div>

    {% if form.variance.errors %}
        {% for error in form.variance.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    <div hidden id="variance_div" class="form-group has-error">
    {% else %}
    <div hidden id="variance_div" class="form-group">
    {% endif %}
        <label for="variance" class="col-sm-2 control-label">Variance from Protocol</label>
        <div class="col-sm-10">
          {{ form.variance }}
        </div>
    </div>

    {% if form.assay_chip_id.errors %}
        {% for error in form.assay_chip_id.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="assay_chip_id" class="col-sm-2 control-label">Chip ID/Barcode*</label>
        <div class="col-sm-10">
          {{ form.assay_chip_id }}
        </div>
    </div>

    {% if form.chip_test_type.errors %}
        {% for error in form.chip_test_type.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="chip_test_type" class="col-sm-2 control-label">Test Type*</label>
        <div class="col-sm-10">
          {{ form.chip_test_type }}
        </div>
    </div>

    <div id="control_warning" hidden class="alert alert-warning" role="alert">
        <span class="glyphicon glyphicon-warning-sign" aria-hidden="true"></span>
        <span class="sr-only">Warning:</span>
        Warning: Compound selected for a control chip
    </div>

    {% if form.concentration.errors %}
        {% for error in form.concentration.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    {% endif %}

    {% if form.non_field_errors %}
        <div class="alert alert-danger" role="alert">
            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
            <span class="sr-only">Error:</span>
            {{ form.non_field_errors }}
        </div>
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <div class="row">
            <div class="col-sm-12 col-lg-6">
                <label for="compound" class="col-sm-2 col-lg-4 control-label">Compound</label>
                <div class="col-sm-10 col-lg-8">
                    {{ form.compound }}
                </div>
            </div>
            <div class="col-sm-12 col-lg-2">
                <label for="concentration" class="col-sm-2 col-lg-8 control-label">Concentration</label>
                <div class="col-sm-10 col-lg-4">
                    {{ form.concentration }}
                </div>
            </div>
            <div class="col-sm-12 col-lg-4">
                <label for="unit" class="col-sm-2 col-lg-7 control-label">Concentration Unit</label>
                <div class="col-sm-10 col-lg-5">
                    {{ form.unit }}
                </div>
            </div>
        </div>
    </div>

    <div class="form-group">
        <label for="scientist" class="col-sm-2 control-label">Scientist</label>
        <div class="col-sm-10">
          {{ form.scientist }}
        </div>
    </div>

    {% if form.notebook_page.errors %}
        {% for error in form.notebook_page.errors %}
            <div class="alert alert-danger" role="alert">
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                <span class="sr-only">Error:</span>
                {{error}}
            </div>
        {% endfor %}
    <div class="form-group has-error">
    {% else %}
    <div class="form-group">
    {% endif %}
        <label for="notebook" class="col-sm-2 col-md-2 control-label">Notebook</label>
        <div class="col-sm-3 col-md-2">
            {{ form.notebook }}
         </div>
        <label for="notebook_page" class="col-sm-3 col-md-2 control-label">Notebook Page</label>
        <div class="col-sm-4 col-md-6">
            {{ form.notebook_page }}
        </div>
    </div>

    <div class="form-group">
        <label for="notes" class="col-sm-2 control-label">Notes</label>
        <div class="col-sm-10">
          {{ form.notes }}
        </div>
    </div>

    {{ formset.management_form }}
    <legend>Model Cells</legend>

    {% if formset.errors %}
        {% for dict in formset.errors %}
            {% for key,value in dict.items %}
                {% if key %}
                    <div class="alert alert-danger" role="alert">
                        <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                        <span class="sr-only">Error:</span>
                        {{ forloop.parentloop.counter }}.) {{ key }} : {{ value }}
                    </div>
                {% endif %}
            {% endfor %}
        {% endfor %}
    {% endif %}

    {% if formset.non_form_errors %}
        <div class="alert alert-danger" role="alert">
            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
            <span class="sr-only">Error:</span>
            {{ formset.non_form_errors }}
        </div>
    {% endif %}

    <p>
        Click a magnifying glass to see a list of available cell samples. Use 'e' for scientific notation: 1e3 = 1000.
        <br>
        <a href="/cellsamples/cellsample">
            <span class="glyphicon glyphicon-plus text-success" aria-hidden="true"></span>
            Add/Edit Cell Samples (Must Refresh Page to See Change)
        </a>
    </p>
    <a id="add_button" class="btn btn-success" role="button">Add Cells</a>

    <table class="table table-striped cells" id="assaychipcells_set-group" name="inlines">
        <thead>
            <tr>
                <th>Cell Sample</th>
                <th>Cell Biosensor</th>
                <th>Density</th>
                <th>Unit</th>
                <th>Passage#</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody>
            {% for cell in formset %}
                <tr class="inline" id="results-{{ forloop.counter0 }}">
                    {# Hidden input for Update (need id to associate) #}
                    {% if cell.id.value %}
                    <td class="original" hidden>
                        <input id="id_assaychipcells_set-{{ forloop.counter0 }}-id" name="assaychipcells_set-{{ forloop.counter0 }}-id" type="hidden" value="{{ cell.id.value }}">
                    </td>
                    {% endif %}
                    <td><input readonly=true id="id_assaychipcells_set-{{ forloop.counter0 }}-cell_sample"
                               name="assaychipcells_set-{{ forloop.counter0 }}-cell_sample" size="5" value={{ cell.cell_sample.value|default_if_none:'' }}>
                        <button id='search-{{ forloop.counter0 }}-' type="button" class="btn btn-xs btn-info" onclick="search(this)">
                            <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
                        </button>
                        <label class="small" id="id_assaychipcells_set-{{ forloop.counter0 }}-cell_sample_label">
                        </label>
                    </td>
                    <td>{{ cell.cell_biosensor }}</td>
                    <td>{{ cell.cellsample_density }}</td>
                    <td>{{ cell.cellsample_density_unit }}</td>
                    <td>{{ cell.cell_passage }}</td>
                    <td>{{ cell.DELETE }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</form>

<div hidden id="dialog" title="Choose a Cell Sample">
    <div class="alert alert-info text-center" role="alert">
            <h1>Click Desired Row</h1>
            <button role="button" class="btn btn-danger" id="clear_cell_sample">Clear Cell Sample</button>
    </div>

    <table id="cellsamples" class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>ID #</th>
                    <th>Receipt Date</th>
                    <th>Cell Type</th>
                    <th>Cell Subtype</th>
                    <th>Supplier</th>
                    <th>Barcode/Lot#</th>
                    <th>Patient</th>
                </tr>
            </thead>

            <tfoot>
                <tr>
                    <th>ID #</th>
                    <th>Receipt Date</th>
                    <th>Cell Type</th>
                    <th>Cell Subtype</th>
                    <th>Supplier</th>
                    <th>Barcode/Lot#</th>
                    <th>Patient</th>
                </tr>
            </tfoot>

            <tbody>
            {% for cellsample in cellsamples %}
                <tr class="cellsample" id={{ cellsample.id }} name="{{ cellsample }}">
                    <td>{{ cellsample.id }}</td>
                    <td>{{ cellsample.receipt_date|date:"M d, Y" }}</td>
                    <td>{{ cellsample.cell_type }}</td>
                    <td>{{ cellsample.cell_subtype }}</td>
                    <td>{{ cellsample.supplier }}</td>
                    <td>{{ cellsample.barcode }}</td>
                    <td>
                        {% if cellsample.patient_age or cellsample.patient_gender != 'N' or cellsample.patient_condition %}
                            {{ cellsample.patient_age|default:"Unknown" }} year old {{ cellsample.patient_gender }}
                            {{ cellsample.patient_condition }}
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
    </table>
</div>

<div hidden id="warning" title="Compound in Control Chip">
    <p>
        <span class="glyphicon glyphicon-exclamation-sign text-danger" aria-hidden="true" style="float:left; margin:0 7px 20px 0;"></span>
        Are you sure you want to add a compound to a control chip?
    </p>
</div>

{# TODO This is subject to change #}
<div hidden id="help_dialog" title="Chip Setup Help">
    <h4>Making a Chip Setup</h4>
    <ul class="list-group">
        <li class="list-group-item">
            A <b>Chip Setup</b> describes the protocols taken to prepare a chip
        </li>
        <li class="list-group-item">
            After selecting an <b>Organ Model</b>, a link to view its standard protocol will appear (granted a PDF has been uploaded)
        </li>
        <li class="list-group-item">
            <b>Variance from Protocol</b> should list the ways this setup diverged from the organ model's standard protocols
        </li>
        <li class="list-group-item">
            The <b>Chip ID/Barcode</b> can not be the same as another chip in the study
        </li>
        <li class="list-group-item">
            <b>Test Type</b> specifies whether the chip functions as a control or not
            <br>
            If the chip is not a control chip, you must specify a compound, concentration, and unit
        </li>
    </ul>
    <h4>Adding Cells</h4>
    <ul class="list-group">
        <li class="list-group-item">
            Each row under the header <b>Model Cells</b> describes cells added to the chip
        </li>
        <li class="list-group-item">
            If this chip does not have any cells, do not modify this section
        </li>
        <li class="list-group-item">
            To get another row, click the <b>Add Cells</b> button
        </li>
        <li class="list-group-item">
            Click a magnifying glass to see a list of available cell samples then click the desired row to select that sample
        </li>
        <li class="list-group-item">
            Use 'e' for scientific notation: e.g. 1e3 = 1000.
        </li>
        <li class="list-group-item">
            If you need a cell sample that is not listed, click the provided link to add it
        </li>
    </ul>
    <h4>Flagging for Review</h4>
    <ul class="list-group">
        <li class="list-group-item">
            Clicking
            <a role='button' class="btn btn-sm" style="color:#337AB7">
                <span class="glyphicon glyphicon-flag" aria-hidden="true"></span>
            </a>
            flags the current setup for review
        </li>
        <li class="list-group-item">
            Clicking
            <a role='button' class="btn btn-sm btn-warning" style="color:#FFFFFF">
                Notes
            </a>
            brings up an input dialog where you can explain why this setup was flagged
        </li>
        <li class="list-group-item">
            Clicking
            <a role='button' class="btn btn-sm btn-danger" style="color:#FFFFFF">
                <span class="glyphicon glyphicon-flag" aria-hidden="true"></span>
            </a>
            removes the flag from the current setup
        </li>
    </ul>
</div>
{% endblock %}
